---
id: how-keploy-works
title: Keploy 工作原理
sidebar_label: 架构解析
tags:
  - 技术说明
  - 测试用例回放
  - 回放指南
  - 录制指南
  - 录制测试用例
---

## 🌟 Keploy V2 架构 🌟

### 🎯 设计目标

- 🛠 **自动插桩:** 无需修改代码
- 📡 **自动流量捕获:** 捕获并操纵进出流量
- ✍️ **可读可编辑:** 测试用例和桩数据易于理解修改
- 🔒 **TLS支持:** 支持HTTPS或数据库的安全连接
- 🔄 **请求匹配:** 通过请求匹配实现测试时的响应模拟

## 🏗 高层架构

Keploy 使用 eBPF 技术实现无代码修改的应用插桩，主要组件包括：

- **eBPF 钩子加载器**
- **网络代理**
- **API 服务端**

<img src="/docs/img/oss/keploy-arch.png?raw=true" alt="Keploy架构图"/>

### 🪝 eBPF 钩子加载器

eBPF 钩子加载器处理入口和出口拦截逻辑：

- **入口拦截器:** 捕获HTTP入站调用并存储为YAML格式，拦截与HTTP请求连接相关的系统调用
- **出口拦截器:** 将TCP和特定UDP连接透明转发至代理进行拦截，应用对此过程无感知

### 🌐 网络代理

网络代理作为透明代理用于记录或模拟出站网络调用：

- **可读性处理:** 将TCP连接的二进制流转换为结构化的YAML，涵盖数据库、缓存、API调用等出站请求
- **未知依赖支持:** 通过base64编码记录二进制数据，测试时使用模糊匹配关联入站请求
- **TLS拦截:** 对HTTPS等TLS连接，通过在应用与代理间插入伪造证书链实现流量拦截

### 🖥 API 服务端

API服务端提供启停命令和资源管理（如测试用例、桩数据），正在演进为支持完整代理模式。

## 🧪 工作示例

假设应用服务器为Web/移动端提供HTTP API，并依赖数据库和外部API：

- **录制模式:** 注入eBPF钩子捕获入站HTTP流量，重定向出站TCP/UDP流量至代理服务器异步存储为YAML
- **测试模式:** 读取YAML测试用例和桩数据，启动应用后发送录制的HTTP请求，同时模拟出站调用响应

这种机制确保了非幂等性操作不会产生副作用。

如有其他问题，欢迎联系我们。

import GetSupport from '../concepts/support.md'

<GetSupport/>